# I-Compass (校内マップシステム)

市川学園文化祭向けのインタラクティブな校内マップ＆ナビゲーションシステムである。
文化祭や学校案内などで、来場者が目的の教室や施設を簡単に見つけられるように設計されている。

## 特徴

### 🗺️ マップ機能 (Visitor Mode)
*   **全フロア統合表示**: 1階〜5階をシームレスに切り替え・表示する。
*   **高度な検索機能**:
    *   **キーワード検索**: 部屋名、企画名などの部分一致検索。
    *   **カテゴリフィルター**: トイレ、自販機、教室など種別ごとの絞り込み。
    *   **優先ソート**: 主要なスポット（エントランス、ホール等）を上位に表示。
*   **ナビゲーション**:
    *   現在地から目的地までの最短ルートを自動計算（ダイクストラ法）。
    *   階をまたぐ移動（階段・エレベーター）に対応。
    *   ステップバイステップのルート案内表示。
*   **UI/UX**:
    *   モバイルファーストなレスポンシブデザイン。
    *   コンパス（羅針盤）をモチーフにしたモダンでプレミアムなデザインテーマ。
    *   スムーズなズーム＆パン操作 (D3.js).
    *   **New! マップ自動回転機能**:
        *   進行方向が常に「上」を向くようにマップを自動回転 (Heading Up)。
        *   ユーザーが設定でON/OFF切り替え可能（デフォルトON）。
        *   回転時も文字ラベルは常に水平を維持し、可読性を確保。
    *   **New! バリアフリーモード**:
        *   階段を回避し、エレベーターを優先するルート探索モード。
        *   設定モーダルからON/OFF切り替え可能。
    *   **New! 動的なフロア表示**:
        *   ルートに関係のない中間階を薄く・小さく表示し、視認性を向上。

### 🔧 補正機能 (Correction Logic)
本システムには、ユーザー体験を損なわないための特殊な補正ロジックが実装されている。

1.  **入力座標の回転補正**:
    *   マップが回転している状態でも、ドラッグ（パン）操作が直感的に行えるように、入力ベクターを逆回転させて適用している。
2.  **ピン・アニメーションの対地補正**:
    *   マップが回転しても、現在地ピンなどの「バウンスアニメーション」が常に画面上の「上」に向かって跳ねるように、描画コンテキストを逆回転補正している。
3.  **無限大・ゼロ除算ガード**:
    *   自動ズーム計算時に発生しうる不正な値を検知し、UI崩壊を防ぐ安全装置（フォールバック機能）を搭載。

### 📐 数式とアルゴリズム詳細

#### 1. ドラッグ操作の回転補正 (Vector Rotation)
画面上で指を `(dx, dy)` 動かした場合、地図は回転角 $\theta$ だけ傾いているため、地図の世界座標系では異なる方向に移動させる必要がある。
これを実現するために、入力ベクトルを逆回転 $-\theta$ させる。

```math
\begin{pmatrix} dx' \\ dy' \end{pmatrix} = \begin{pmatrix} \cos(-\theta) & -\sin(-\theta) \\ \sin(-\theta) & \cos(-\theta) \end{pmatrix} \begin{pmatrix} dx \\ dy \end{pmatrix}
```
コード内 (`map-core.js`) では以下のように実装されている：
```javascript
const rad = this.rotation * Math.PI / 180;
const cos = Math.cos(rad);
const sin = Math.sin(rad);
// R(-θ) の計算 (cos(-θ)=cos(θ), sin(-θ)=-sin(θ))
const dtx = dx * cos + dy * sin;
const dty = -dx * sin + dy * cos;
```

#### 2. ピンのアニメーション補正 (Context Counter-Rotation)
HTML Canvas の描画コンテキストは、一度回転させるとその後の描画命令すべてが回転する。
ピンを「画面の上」に向かって跳ねさせるためには、一度回転した座標系を**一時的に元に戻す**必要がある。

1. **移動**: ピンの場所 `(x, y)` へ原点を移動。
2. **回転**: 地図の回転 `theta` を適用（ここは親の変換で適用済み）。
3. **逆回転**: `ctx.rotate(-theta)` を適用し、座標軸を画面の垂直・水平に戻す。
4. **描画**: この状態で `y` 方向にオフセット（バウンス）を加えることで、常に「画面の上」へのアニメーションとなる。

### 🛠️ エディタ機能 (Admin Mode)
`editor.html` からマップデータの作成・編集が可能である。
*   **ノード編集**: 部屋、廊下、階段などのポイントを追加・移動・削除。
*   **メタデータ管理**: 部屋名に加え、文化祭の**企画名**や展示団体名も登録可能。
*   **接続管理**: ノード間をリンクして経路ネットワークを構築。
*   **JSON入出力**: 編集データをJSON形式で保存・読み込み。

## 動作環境

本システムはモダンブラウザ（Chrome, Safari, Edge, Firefox）で動作する。
ES Modules (`import/export`) および `fetch` API を使用しているため、ローカルで動作させる場合は簡易的なWebサーバーが必要である。

### ローカルでの起動方法 (例: Python)

```bash
# プロジェクトリポジトリに移動
cd school-map

# HTTPサーバーを起動
python -m http.server 8000

# ブラウザでアクセス
# マップ: http://localhost:8000/map.html
# エディタ: http://localhost:8000/editor.html
```

## ファイル構成

*   `map.html`: 一般利用者向けマップ画面
*   `editor.html`: 管理者向けマップデータ編集画面
*   `assets/`: 静的リソース
    *   `js/`: アプリケーションロジック (`map-core.js`, `ui-controller.js` 等)
    *   `css/`: スタイルシート
*   `JSON/`: フロアごとのマップデータ (`1.json` 〜 `5.json`) および設定ファイル (`order.json`)
*   `images/`: フロア図面画像

## 技術仕様 (Technical Details)

本システムは外部ライブラリの依存を最小限に抑え、軽量かつ高速に動作するように設計されている。

### 1. アーキテクチャ
*   **MapEngine (`map-core.js`)**:
    *   地図の描画（D3.js）、フロアデータの読み込み、座標変換、経路探索アルゴリズムの中核を担う。
    *   各フロアの座標系を統合し、全階層を単一のグラフネットワークとして扱う。
*   **UIController (`ui-controller.js`)**:
    *   ユーザーインターフェース（検索ボックス、ドロップダウン、現在地・目的地の選択）を管理する。
    *   ユーザーの入力を受け取り、MapEngineのAPIを呼び出して経路を描画させる。
*   **Configuration (`config.js`)**:
    *   フロア構成、画像パス、座標オフセットなどの設定を集約し、コードの変更なしでマップ定義を変更可能である。

### 2. 経路探索アルゴリズム
*   **ダイクストラ法 (Dijkstra's Algorithm)**: 指定された「現在地」から「目的地」までの最短経路を計算する。
*   **Ghost Graph (仮想統合グラフ)**:
    *   各フロアのマップデータ (`1.json`～`5.json`) は独立しているが、ロード時に `MapEngine` がこれらを統合する。
    *   階段やエレベーターなど、同じ名称（例: "階段A"）を持つノード同士は、自動的に仮想的なエッジ（重み付きリンク）で接続される。
    *   これにより、ユーザーは階数を意識することなく、「1階の入口」から「3階の教室」へのルートを一回の計算で導き出せる。

### 3. データ構造
マップデータは独自のJSONフォーマットで管理されている。

```json
{
  "nodes": [
    {
      "id": 1709...,
      "x": 100, "y": 200,
      "type": "room",   // room, toilet, stairs, elevator, etc.
      "name": "3-A",    // 表示名
      "eventName": "お化け屋敷", // (任意) 企画名
      "floorId": 3      // (自動付与)
    }
  ],
  "edges": [
    { "from": 1709..., "to": 1710..., "dist": 50 }
  ]
}
```

### 4. カスタマイズ
*   **表示順序 (`order.json`)**: ドロップダウンリスト内での表示優先順位を定義する。部分一致により、特定のキーワード（例: "自販機"）を含む施設の表示順を制御できる。
*   **スタイル (`style.css`)**: CSS変数 (`:root`) を使用しており、テーマカラー（メイン、アクセント、背景色）を簡単に変更可能である。

## Copyright

&copy; 2026 市川学園 & Junxiang Jin. All rights reserved.
