<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>I-Compass</title>

    <!-- Fonts (Loaded via style.css @import) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
</head>

<body>
    <!-- Opening Animation Overlay -->
    <div id="opening-overlay">
        <div class="opening-content">
            <div class="compass-logo-large">
                <div class="compass-needle-large"></div>
            </div>
            <h1 class="opening-title">I-Compass</h1>
            <div class="opening-status">システム起動中...</div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="header-row">
                    <h1 class="logo-text">I-Compass</h1>
                    <button id="sidebar-close-btn" class="icon-btn mobile-only">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </button>
                </div>
                <div class="floor-tabs" id="floor-tabs">
                    <!-- Javascript will populate buttons here -->
                </div>
            </div>

            <div class="search-panel">
                <div class="control-group">
                    <label class="control-label">出発地</label>
                    <!-- Custom Select Container -->
                    <div class="custom-select" id="custom-start-select">
                        <div class="select-trigger" tabindex="0">
                            <span class="selection-text">出発地を選択...</span>
                            <div class="arrow"></div>
                        </div>
                        <div class="select-options">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">目的地</label>
                    <div class="custom-select" id="custom-end-select">
                        <div class="select-trigger" tabindex="0">
                            <span class="selection-text">目的地を選択...</span>
                            <div class="arrow"></div>
                        </div>
                        <div class="select-options">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>

                <div class="route-container">
                    <label class="control-label">ナビゲーションルート</label>
                    <ul class="route-list" id="route-list">
                        <!-- Route steps will appear here -->
                    </ul>
                </div>
            </div>
        </div>
        <div class="sidebar-footer">
            &copy; 2026 市川学園 & Junxiang Jin. All rights reserved.
        </div>

        <!-- Map Area -->
        <div class="map-container" id="map-wrapper">
            <canvas id="mapCanvas"></canvas>

            <!-- Controls -->
            <div class="map-controls">
                <button class="control-btn" id="fit-map" title="全体表示">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M5 5h5v2H7v3H5V5zm9 0h5v5h-2V7h-3V5zm5 9h-2v3h-3v2h5v-5zm-14 0v5h5v-2H7v-3H5z" />
                    </svg>
                </button>
                <button class="control-btn" id="zoom-in" title="拡大">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                </button>
                <button class="control-btn" id="zoom-out" title="縮小">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19 13H5v-2h14v2z" />
                    </svg>
                </button>
            </div>

            <!-- Scan Button (Independent Position) -->
            <button class="control-btn" id="scan-btn" title="QRスキャン">
                <svg viewBox="0 0 48 48" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9.52" y="9.52" width="12.31" height="12.31" rx="0" ry="0" />
                    <rect x="9.52" y="26.17" width="12.31" height="12.31" rx="0" ry="0" />
                    <rect x="26.17" y="9.52" width="12.31" height="12.31" transform="translate(16.65 48) rotate(-90)"
                        rx="0" ry="0" />
                    <polyline points="4.17 11.46 4.17 4.17 11.46 4.17" />
                    <polyline points="36.54 4.17 43.83 4.17 43.83 11.46" />
                    <polyline points="4.17 36.54 4.17 43.83 11.46 43.83" />
                    <polyline points="36.54 43.83 43.83 43.83 43.83 36.54" />

                    <!-- Solid Dots (Fill currentColor, no stroke) -->
                    <rect x="14.67" y="14.74" width="2" height="2" fill="currentColor" stroke="none" />
                    <rect x="31.33" y="14.74" width="2" height="2" fill="currentColor" stroke="none" />
                    <rect x="14.67" y="31.33" width="2" height="2" fill="currentColor" stroke="none" />
                    <rect x="31.33" y="31.33" width="2" height="2" fill="currentColor" stroke="none" />

                    <!-- Inner Squares (Stroke only, miterlimit) -->
                    <rect x="13.71" y="13.77" width="3.93" height="3.93" stroke-miterlimit="10" />
                    <rect x="30.36" y="13.77" width="3.93" height="3.93" stroke-miterlimit="10" />
                    <rect x="13.71" y="30.36" width="3.93" height="3.93" stroke-miterlimit="10" />
                    <rect x="30.36" y="30.36" width="3.93" height="3.93" stroke-miterlimit="10" />

                    <!-- Bottom Right Feature -->
                    <rect x="28.37" y="28.37" width="7.91" height="7.91" />
                </svg>
            </button>
        </div>

        <!-- Mobile: Menu Button to open Sidebar -->
        <button id="mobile-menu-btn" class="mobile-fab box-shadow">
            <!-- Search Icon -->
            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                <path
                    d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
        </button>

        <!-- Mobile: Route Overlay (Top-Right) -->
        <div id="mobile-route-overlay" class="mobile-overlay hidden">
            <div class="overlay-header">
                <span class="header-title">ルート案内</span>
                <button id="overlay-toggle-btn" class="overlay-toggle">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                    </svg>
                </button>
            </div>
            <div id="mobile-route-content"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>マップデータを読み込み中...</div>
    </div>

    <!-- QR Overlay -->
    <div id="qr-overlay" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div
            style="position:relative; width:90%; max-width:500px; background:white; padding:20px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.5);">
            <button id="close-qr-btn"
                style="position:absolute; top:10px; right:10px; background:none; border:none; cursor:pointer; color:#333;">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </button>
            <div
                style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:0; margin-bottom:10px;">
                <h3 style="margin:0; color:#333;">QRコードをスキャン</h3>
                <button id="qr-help-btn"
                    style="background:none; border:none; cursor:pointer; color:#aaa; display:flex; align-items:center;"
                    title="使い方">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                    </svg>
                </button>
            </div>
            <div id="reader" style="width:100%;"></div>
        </div>
        <!-- Simple Background Backdrop handled by flex parent styling if needed, but styling inline for simplicity check:
             Wait, style attribute above has "bg:". Should be background. Fixing inline style.
        -->
    </div>

    <!-- QR Help Modal -->
    <div id="qr-help-modal" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:10001; display:flex; justify-content:center; align-items:center;">
        <div
            style="background:white; padding:25px; border-radius:12px; max-width:400px; width:85%; box-shadow:0 10px 25px rgba(0,0,0,0.3);">
            <h4 style="margin-top:0; color:#333; font-size:18px; border-bottom:1px solid #eee; padding-bottom:10px;">
                QRスキャンの使い方</h4>
            <div style="font-size:14px; color:#555; line-height:1.6; margin:15px 0;">
                <p>校内の各地点に設置されているQRコードをこのカメラで読み取ると、地図上に<b>「現在地」</b>が表示されます。</p>
                <p>ナビゲーション機能と併用することで、現在地から目的地までのルートをスムーズに確認できます。</p>
            </div>
            <button id="close-help-btn"
                style="width:100%; padding:10px; background:#007bff; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">閉じる</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/map-core.js"></script>
    <script src="assets/js/ui-controller.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Init App
            const engine = new MapEngine('mapCanvas', 'map-wrapper');
            window.ui = new UIController(engine);

            // Check URL params for floor
            const params = new URLSearchParams(window.location.search);
            const floor = params.get('floor');
            if (floor) {
                window.ui.switchFloor(parseInt(floor));
            }
        });
    </script>
</body>

</html>