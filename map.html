<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>I-Compass</title>

    <!-- Fonts (Loaded via style.css @import) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Styles -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
</head>

<body>
    <!-- Opening Animation Overlay -->
    <div id="opening-overlay">
        <div class="opening-content">
            <div class="compass-logo-large">
                <div class="compass-needle-large"></div>
            </div>
            <h1 class="opening-title">I-Compass</h1>
            <div class="opening-status">システム起動中...</div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="header-row">
                    <h1 class="logo-text">I-Compass</h1>
                    <button id="sidebar-close-btn" class="icon-btn mobile-only">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </button>
                </div>
                <div class="floor-tabs" id="floor-tabs">
                    <!-- Javascript will populate buttons here -->
                </div>
            </div>

            <div class="search-panel">
                <div class="control-group">
                    <label class="control-label">出発地</label>
                    <!-- Custom Select Container -->
                    <div class="custom-select" id="custom-start-select">
                        <div class="select-trigger" tabindex="0">
                            <span class="selection-text">出発地を選択...</span>
                            <div class="arrow"></div>
                        </div>
                        <div class="select-options">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">目的地</label>
                    <div class="custom-select" id="custom-end-select">
                        <div class="select-trigger" tabindex="0">
                            <span class="selection-text">目的地を選択...</span>
                            <div class="arrow"></div>
                        </div>
                        <div class="select-options">
                            <!-- JS Populated -->
                        </div>
                    </div>
                </div>

                <div class="route-container">
                    <label class="control-label">ナビゲーションルート</label>
                    <ul class="route-list" id="route-list">
                        <!-- Route steps will appear here -->
                    </ul>
                </div>
            </div>
        </div>
        <div class="sidebar-footer">
            &copy; 2026 市川学園 & Junxiang Jin. All rights reserved.
        </div>

        <!-- Map Area -->
        <div class="map-container" id="map-wrapper">
            <canvas id="mapCanvas"></canvas>

            <!-- Controls -->
            <div class="map-controls">
                <button class="control-btn" id="settings-btn" title="設定">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path
                            d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.73,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.43-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
                    </svg>
                </button>
                <button class="control-btn" id="fit-map" title="全体表示">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M5 5h5v2H7v3H5V5zm9 0h5v5h-2V7h-3V5zm5 9h-2v3h-3v2h5v-5zm-14 0v5h5v-2H7v-3H5z" />
                    </svg>
                </button>
                <button class="control-btn" id="zoom-in" title="拡大">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                    </svg>
                </button>
                <button class="control-btn" id="zoom-out" title="縮小">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19 13H5v-2h14v2z" />
                    </svg>
                </button>
                <div class="control-separator"></div>
                <button class="control-btn" id="rotate-left" title="左回転">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path
                            d="M7.11 8.53L5.7 7.11C4.8 8.27 4.24 9.61 4.07 11h2.02c.14-.87.49-1.72 1.02-2.47zM6.09 13H4.07c.17 1.39.72 2.73 1.62 3.89l1.41-1.42c-.52-.75-.87-1.59-1.01-2.47zm1.01 5.32c1.16.9 2.51 1.44 3.9 1.61V17.9c-.87-.15-1.71-.49-2.46-1.03L7.1 18.32zM13 4.07V1L8.45 5.55 13 10V6.09c2.84.48 5 2.94 5 5.91s-2.16 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93s-3.05-7.44-7-7.93z" />
                    </svg>
                </button>
                <button class="control-btn" id="rotate-right" title="右回転">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path
                            d="M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11c-.17-1.39-.72-2.73-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.42-1.42c-.75.54-1.58.88-2.48 1.01zM17.9 13h2.02c-.17 1.39-.72 2.73-1.62 3.89l-1.42-1.42c.54-.75.88-1.6 1.02-2.47z" />
                    </svg>
                </button>
            </div>

            <!-- Scan Button (Independent Position) -->
            <button class="control-btn" id="scan-btn" title="QRスキャン">
                <svg viewBox="0 0 48 48" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9.52" y="9.52" width="12.31" height="12.31" rx="0" ry="0" />
                    <rect x="9.52" y="26.17" width="12.31" height="12.31" rx="0" ry="0" />
                    <rect x="26.17" y="9.52" width="12.31" height="12.31" transform="translate(16.65 48) rotate(-90)"
                        rx="0" ry="0" />
                    <polyline points="4.17 11.46 4.17 4.17 11.46 4.17" />
                    <polyline points="36.54 4.17 43.83 4.17 43.83 11.46" />
                    <polyline points="4.17 36.54 4.17 43.83 11.46 43.83" />
                    <polyline points="36.54 43.83 43.83 43.83 43.83 36.54" />

                    <!-- Solid Dots (Fill currentColor, no stroke) -->
                    <rect x="14.67" y="14.74" width="2" height="2" fill="currentColor" stroke="none" />
                    <rect x="31.33" y="14.74" width="2" height="2" fill="currentColor" stroke="none" />
                    <rect x="14.67" y="31.33" width="2" height="2" fill="currentColor" stroke="none" />
                    <rect x="31.33" y="31.33" width="2" height="2" fill="currentColor" stroke="none" />

                    <!-- Inner Squares (Stroke only, miterlimit) -->
                    <rect x="13.71" y="13.77" width="3.93" height="3.93" stroke-miterlimit="10" />
                    <rect x="30.36" y="13.77" width="3.93" height="3.93" stroke-miterlimit="10" />
                    <rect x="13.71" y="30.36" width="3.93" height="3.93" stroke-miterlimit="10" />
                    <rect x="30.36" y="30.36" width="3.93" height="3.93" stroke-miterlimit="10" />

                    <!-- Bottom Right Feature -->
                    <rect x="28.37" y="28.37" width="7.91" height="7.91" />
                </svg>
            </button>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden">
            <div class="settings-modal-content">
                <div class="settings-header">
                    <h3>設定</h3>
                    <button id="close-settings-btn" class="close-btn">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#333">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg>
                    </button>
                </div>
                <div class="settings-body">
                    <div class="setting-item">
                        <div class="setting-text">
                            <span class="setting-title">地図の自動回転</span>
                            <span class="setting-desc">進行方向を上にして表示します</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-rotation" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="setting-item">
                        <div class="setting-text">
                            <span class="setting-title">バリアフリーモード</span>
                            <span class="setting-desc">エレベーターを使用し、階段を避けるルートを表示します</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-accessibility">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile: Menu Button to open Sidebar -->
        <button id="mobile-menu-btn" class="mobile-fab box-shadow">
            <!-- Search Icon -->
            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                <path
                    d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
        </button>

        <!-- Mobile: Route Overlay (Top-Right) -->
        <div id="mobile-route-overlay" class="mobile-overlay hidden">
            <div class="overlay-header">
                <span class="header-title">ルート案内</span>
                <button id="overlay-toggle-btn" class="overlay-toggle">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="white">
                        <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                    </svg>
                </button>
            </div>
            <div id="mobile-route-content"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>マップデータを読み込み中...</div>
    </div>

    <!-- QR Overlay -->
    <div id="qr-overlay" class="hidden">
        <div class="qr-container">
            <div class="qr-header">
                <h3 class="qr-title">QRコードをスキャン</h3>
                <button id="qr-help-btn" title="使い方">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                    </svg>
                </button>
                <button id="close-qr-btn" title="閉じる">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                    </svg>
                </button>
            </div>

            <div id="reader">
                <!-- Manual Video/Canvas Elements for jsQR -->
                <video id="qr-video" muted playsinline style="display:none;"></video>
                <canvas id="qr-canvas" style="width:100%; height:100%; object-fit:cover;"></canvas>

                <!-- Visual Frame Overlay (Absolute) -->
                <div class="scan-region-overlay">
                    <div class="scan-region-inner"></div>
                    <div class="scan-line"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Help Modal -->
    <div id="qr-help-modal" class="hidden">
        <div class="help-modal-content">
            <h4 class="help-title">QRスキャンの使い方</h4>
            <div class="help-body">
                <p>校内の各地点に設置されているQRコードをこのカメラで読み取ると、地図上に<b>「現在地」</b>が表示されます。</p>
                <p>ナビゲーション機能と併用することで、現在地から目的地までのルートをスムーズに確認できます。</p>
            </div>
            <button id="close-help-btn" class="help-close-btn">閉じる</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/map-core.js"></script>
    <script src="assets/js/ui-controller.js"></script>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Init App
            const engine = new MapEngine('mapCanvas', 'map-wrapper');
            window.ui = new UIController(engine);

            // Check URL params for floor
            const params = new URLSearchParams(window.location.search);
            const floor = params.get('floor');
            if (floor) {
                window.ui.switchFloor(parseInt(floor));
            }
        });
    </script>
</body>

</html>